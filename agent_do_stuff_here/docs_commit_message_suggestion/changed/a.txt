refactor auth flow and cleanup guards
